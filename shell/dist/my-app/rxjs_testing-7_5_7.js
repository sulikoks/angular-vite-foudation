import{__values,__spreadArray,__read,__extends}from"tslib";function isFunction(value){return"function"==typeof value}function createErrorClass(createImpl){var ctorFunc=createImpl(function(instance){Error.call(instance),instance.stack=new Error().stack});return ctorFunc.prototype=Object.create(Error.prototype),ctorFunc.prototype.constructor=ctorFunc,ctorFunc}var UnsubscriptionError=createErrorClass(function(_super){return function(errors){_super(this),this.message=errors?errors.length+" errors occurred during unsubscription:\n"+errors.map(function(err,i){return i+1+") "+err.toString()}).join("\n  "):"",this.name="UnsubscriptionError",this.errors=errors}});function arrRemove(arr,item){if(arr){var index=arr.indexOf(item);0<=index&&arr.splice(index,1)}}var Subscription=function(){function Subscription(initialTeardown){this.initialTeardown=initialTeardown,this.closed=!1,this._parentage=null,this._finalizers=null}var empty;return Subscription.prototype.unsubscribe=function(){var e_1,_a,e_2,_b,errors;if(!this.closed){this.closed=!0;var _parentage=this._parentage;if(_parentage)if(this._parentage=null,Array.isArray(_parentage))try{for(var _parentage_1=__values(_parentage),_parentage_1_1=_parentage_1.next();!_parentage_1_1.done;_parentage_1_1=_parentage_1.next()){_parentage_1_1.value.remove(this)}}catch(e_1_1){e_1={error:e_1_1}}finally{try{_parentage_1_1&&!_parentage_1_1.done&&(_a=_parentage_1.return)&&_a.call(_parentage_1)}finally{if(e_1)throw e_1.error}}else _parentage.remove(this);var initialFinalizer=this.initialTeardown;if(isFunction(initialFinalizer))try{initialFinalizer()}catch(e){errors=e instanceof UnsubscriptionError?e.errors:[e]}var _finalizers=this._finalizers;if(_finalizers){this._finalizers=null;try{for(var _finalizers_1=__values(_finalizers),_finalizers_1_1=_finalizers_1.next();!_finalizers_1_1.done;_finalizers_1_1=_finalizers_1.next()){var finalizer=_finalizers_1_1.value;try{execFinalizer(finalizer)}catch(err){errors=null!=errors?errors:[],err instanceof UnsubscriptionError?errors=__spreadArray(__spreadArray([],__read(errors)),__read(err.errors)):errors.push(err)}}}catch(e_2_1){e_2={error:e_2_1}}finally{try{_finalizers_1_1&&!_finalizers_1_1.done&&(_b=_finalizers_1.return)&&_b.call(_finalizers_1)}finally{if(e_2)throw e_2.error}}}if(errors)throw new UnsubscriptionError(errors)}},Subscription.prototype.add=function(teardown){var _a;if(teardown&&teardown!==this)if(this.closed)execFinalizer(teardown);else{if(teardown instanceof Subscription){if(teardown.closed||teardown._hasParent(this))return;teardown._addParent(this)}(this._finalizers=null!==(_a=this._finalizers)&&void 0!==_a?_a:[]).push(teardown)}},Subscription.prototype._hasParent=function(parent){var _parentage=this._parentage;return _parentage===parent||Array.isArray(_parentage)&&_parentage.includes(parent)},Subscription.prototype._addParent=function(parent){var _parentage=this._parentage;this._parentage=Array.isArray(_parentage)?(_parentage.push(parent),_parentage):_parentage?[_parentage,parent]:parent},Subscription.prototype._removeParent=function(parent){var _parentage=this._parentage;_parentage===parent?this._parentage=null:Array.isArray(_parentage)&&arrRemove(_parentage,parent)},Subscription.prototype.remove=function(teardown){var _finalizers=this._finalizers;_finalizers&&arrRemove(_finalizers,teardown),teardown instanceof Subscription&&teardown._removeParent(this)},Subscription.EMPTY=((empty=new Subscription).closed=!0,empty),Subscription}(),EMPTY_SUBSCRIPTION=Subscription.EMPTY;function isSubscription(value){return value instanceof Subscription||value&&"closed"in value&&isFunction(value.remove)&&isFunction(value.add)&&isFunction(value.unsubscribe)}function execFinalizer(finalizer){isFunction(finalizer)?finalizer():finalizer.unsubscribe()}var config={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},timeoutProvider={setTimeout:function(handler,timeout){for(var args=[],_i=2;_i<arguments.length;_i++)args[_i-2]=arguments[_i];var delegate=timeoutProvider.delegate;return(null==delegate?void 0:delegate.setTimeout)?delegate.setTimeout.apply(delegate,__spreadArray([handler,timeout],__read(args))):setTimeout.apply(void 0,__spreadArray([handler,timeout],__read(args)))},clearTimeout:function(handle){var delegate=timeoutProvider.delegate;return((null==delegate?void 0:delegate.clearTimeout)||clearTimeout)(handle)},delegate:void 0};function noop(){}var COMPLETE_NOTIFICATION=createNotification("C",void 0,void 0);function errorNotification(error){return createNotification("E",void 0,error)}function nextNotification(value){return createNotification("N",value,void 0)}function createNotification(kind,value,error){return{kind:kind,value:value,error:error}}function errorContext(cb){cb()}var Subscriber=function(_super){function Subscriber(destination){var _this=_super.call(this)||this;return _this.isStopped=!1,destination?(_this.destination=destination,isSubscription(destination)&&destination.add(_this)):_this.destination=EMPTY_OBSERVER,_this}return __extends(Subscriber,_super),Subscriber.create=function(next,error,complete){return new SafeSubscriber(next,error,complete)},Subscriber.prototype.next=function(value){this.isStopped||this._next(value)},Subscriber.prototype.error=function(err){this.isStopped||(this.isStopped=!0,this._error(err))},Subscriber.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},Subscriber.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,_super.prototype.unsubscribe.call(this),this.destination=null)},Subscriber.prototype._next=function(value){this.destination.next(value)},Subscriber.prototype._error=function(err){try{this.destination.error(err)}finally{this.unsubscribe()}},Subscriber.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},Subscriber}(Subscription),_bind=Function.prototype.bind;function bind(fn,thisArg){return _bind.call(fn,thisArg)}var ConsumerObserver=function(){function ConsumerObserver(partialObserver){this.partialObserver=partialObserver}return ConsumerObserver.prototype.next=function(value){var partialObserver=this.partialObserver;if(partialObserver.next)try{partialObserver.next(value)}catch(error){handleUnhandledError(error)}},ConsumerObserver.prototype.error=function(err){var partialObserver=this.partialObserver;if(partialObserver.error)try{partialObserver.error(err)}catch(error){handleUnhandledError(error)}else handleUnhandledError(err)},ConsumerObserver.prototype.complete=function(){var partialObserver=this.partialObserver;if(partialObserver.complete)try{partialObserver.complete()}catch(error){handleUnhandledError(error)}},ConsumerObserver}(),SafeSubscriber=function(_super){function SafeSubscriber(observerOrNext,error,complete){var partialObserver,context_1,_this=_super.call(this)||this;isFunction(observerOrNext)||!observerOrNext?partialObserver={next:null!=observerOrNext?observerOrNext:void 0,error:null!=error?error:void 0,complete:null!=complete?complete:void 0}:_this&&config.useDeprecatedNextContext?((context_1=Object.create(observerOrNext)).unsubscribe=function(){return _this.unsubscribe()},partialObserver={next:observerOrNext.next&&bind(observerOrNext.next,context_1),error:observerOrNext.error&&bind(observerOrNext.error,context_1),complete:observerOrNext.complete&&bind(observerOrNext.complete,context_1)}):partialObserver=observerOrNext;return _this.destination=new ConsumerObserver(partialObserver),_this}return __extends(SafeSubscriber,_super),SafeSubscriber}(Subscriber);function handleUnhandledError(error){var err;err=error,timeoutProvider.setTimeout(function(){throw err})}var EMPTY_OBSERVER={closed:!0,next:noop,error:function(err){throw err},complete:noop},observable="function"==typeof Symbol&&Symbol.observable||"@@observable";function identity(x){return x}function pipeFromArray(fns){return 0===fns.length?identity:1===fns.length?fns[0]:function(input){return fns.reduce(function(prev,fn){return fn(prev)},input)}}var Observable=function(){function Observable(subscribe){subscribe&&(this._subscribe=subscribe)}return Observable.prototype.lift=function(operator){var observable=new Observable;return observable.source=this,observable.operator=operator,observable},Observable.prototype.subscribe=function(observerOrNext,error,complete){var value,_this=this,subscriber=(value=observerOrNext)&&value instanceof Subscriber||function(value){return value&&isFunction(value.next)&&isFunction(value.error)&&isFunction(value.complete)}(value)&&isSubscription(value)?observerOrNext:new SafeSubscriber(observerOrNext,error,complete);return errorContext(function(){var _a=_this,operator=_a.operator,source=_a.source;subscriber.add(operator?operator.call(subscriber,source):source?_this._subscribe(subscriber):_this._trySubscribe(subscriber))}),subscriber},Observable.prototype._trySubscribe=function(sink){try{return this._subscribe(sink)}catch(err){sink.error(err)}},Observable.prototype.forEach=function(next,promiseCtor){var _this=this;return new(promiseCtor=getPromiseCtor(promiseCtor))(function(resolve,reject){var subscriber=new SafeSubscriber({next:function(value){try{next(value)}catch(err){reject(err),subscriber.unsubscribe()}},error:reject,complete:resolve});_this.subscribe(subscriber)})},Observable.prototype._subscribe=function(subscriber){var _a;return null===(_a=this.source)||void 0===_a?void 0:_a.subscribe(subscriber)},Observable.prototype[observable]=function(){return this},Observable.prototype.pipe=function(){for(var operations=[],_i=0;_i<arguments.length;_i++)operations[_i]=arguments[_i];return pipeFromArray(operations)(this)},Observable.prototype.toPromise=function(promiseCtor){var _this=this;return new(promiseCtor=getPromiseCtor(promiseCtor))(function(resolve,reject){var value;_this.subscribe(function(x){return value=x},function(err){return reject(err)},function(){return resolve(value)})})},Observable.create=function(subscribe){return new Observable(subscribe)},Observable}();function getPromiseCtor(promiseCtor){var _a;return null!==(_a=null!=promiseCtor?promiseCtor:config.Promise)&&void 0!==_a?_a:Promise}var NotificationKind,SubscriptionLog=function(subscribedFrame,unsubscribedFrame){void 0===unsubscribedFrame&&(unsubscribedFrame=1/0),this.subscribedFrame=subscribedFrame,this.unsubscribedFrame=unsubscribedFrame},SubscriptionLoggable=function(){function SubscriptionLoggable(){this.subscriptions=[]}return SubscriptionLoggable.prototype.logSubscribedFrame=function(){return this.subscriptions.push(new SubscriptionLog(this.scheduler.now())),this.subscriptions.length-1},SubscriptionLoggable.prototype.logUnsubscribedFrame=function(index){var subscriptionLogs=this.subscriptions,oldSubscriptionLog=subscriptionLogs[index];subscriptionLogs[index]=new SubscriptionLog(oldSubscriptionLog.subscribedFrame,this.scheduler.now())},SubscriptionLoggable}();function applyMixins(derivedCtor,baseCtors){for(var i=0,len=baseCtors.length;i<len;i++)for(var baseCtor=baseCtors[i],propertyKeys=Object.getOwnPropertyNames(baseCtor.prototype),j=0,len2=propertyKeys.length;j<len2;j++){var name_1=propertyKeys[j];derivedCtor.prototype[name_1]=baseCtor.prototype[name_1]}}function observeNotification(notification,observer){var _a,_b,_c,_d=notification,kind=_d.kind,value=_d.value,error=_d.error;if("string"!=typeof kind)throw new TypeError("Invalid notification, missing \"kind\"");"N"===kind?null===(_a=observer.next)||void 0===_a||_a.call(observer,value):"E"===kind?null===(_b=observer.error)||void 0===_b||_b.call(observer,error):null===(_c=observer.complete)||void 0===_c||_c.call(observer)}new Observable(function(subscriber){return subscriber.complete()}),function(_super){function OperatorSubscriber(destination,onNext,onComplete,onError,onFinalize,shouldUnsubscribe){var _this=_super.call(this,destination)||this;return _this.onFinalize=onFinalize,_this.shouldUnsubscribe=shouldUnsubscribe,_this._next=onNext?function(value){try{onNext(value)}catch(err){destination.error(err)}}:_super.prototype._next,_this._error=onError?function(err){try{onError(err)}catch(err){destination.error(err)}finally{this.unsubscribe()}}:_super.prototype._error,_this._complete=onComplete?function(){try{onComplete()}catch(err){destination.error(err)}finally{this.unsubscribe()}}:_super.prototype._complete,_this}__extends(OperatorSubscriber,_super),OperatorSubscriber.prototype.unsubscribe=function(){var _a;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var closed_1=this.closed;_super.prototype.unsubscribe.call(this),!closed_1&&(null===(_a=this.onFinalize)||void 0===_a||_a.call(this))}}}(Subscriber),function(NotificationKind){NotificationKind.NEXT="N",NotificationKind.ERROR="E",NotificationKind.COMPLETE="C"}(NotificationKind||(NotificationKind={}));var ColdObservable=function(_super){function ColdObservable(messages,scheduler){var _this=_super.call(this,function(subscriber){var observable=this,index=observable.logSubscribedFrame(),subscription=new Subscription;return subscription.add(new Subscription(function(){observable.logUnsubscribedFrame(index)})),observable.scheduleMessages(subscriber),subscription})||this;return _this.messages=messages,_this.subscriptions=[],_this.scheduler=scheduler,_this}return __extends(ColdObservable,_super),ColdObservable.prototype.scheduleMessages=function(subscriber){for(var messagesLength=this.messages.length,i=0;i<messagesLength;i++){var message=this.messages[i];subscriber.add(this.scheduler.schedule(function(state){var _a=state;observeNotification(_a.message.notification,_a.subscriber)},message.frame,{message:message,subscriber:subscriber}))}},ColdObservable}(Observable);applyMixins(ColdObservable,[SubscriptionLoggable]);var ObjectUnsubscribedError=createErrorClass(function(_super){return function(){_super(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),Subject=function(_super){function Subject(){var _this=_super.call(this)||this;return _this.closed=!1,_this.currentObservers=null,_this.observers=[],_this.isStopped=!1,_this.hasError=!1,_this.thrownError=null,_this}return __extends(Subject,_super),Subject.prototype.lift=function(operator){var subject=new AnonymousSubject(this,this);return subject.operator=operator,subject},Subject.prototype._throwIfClosed=function(){if(this.closed)throw new ObjectUnsubscribedError},Subject.prototype.next=function(value){var _this=this;errorContext(function(){var e_1,_a;if(_this._throwIfClosed(),!_this.isStopped){_this.currentObservers||(_this.currentObservers=Array.from(_this.observers));try{for(var _b=__values(_this.currentObservers),_c=_b.next();!_c.done;_c=_b.next()){_c.value.next(value)}}catch(e_1_1){e_1={error:e_1_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_1)throw e_1.error}}}})},Subject.prototype.error=function(err){var _this=this;errorContext(function(){if(_this._throwIfClosed(),!_this.isStopped){_this.hasError=_this.isStopped=!0,_this.thrownError=err;for(var observers=_this.observers;observers.length;)observers.shift().error(err)}})},Subject.prototype.complete=function(){var _this=this;errorContext(function(){if(_this._throwIfClosed(),!_this.isStopped){_this.isStopped=!0;for(var observers=_this.observers;observers.length;)observers.shift().complete()}})},Subject.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(Subject.prototype,"observed",{get:function(){var _a;return(null===(_a=this.observers)||void 0===_a?void 0:_a.length)>0},enumerable:!1,configurable:!0}),Subject.prototype._trySubscribe=function(subscriber){return this._throwIfClosed(),_super.prototype._trySubscribe.call(this,subscriber)},Subject.prototype._subscribe=function(subscriber){return this._throwIfClosed(),this._checkFinalizedStatuses(subscriber),this._innerSubscribe(subscriber)},Subject.prototype._innerSubscribe=function(subscriber){var _this=this,hasError=this.hasError,isStopped=this.isStopped,observers=this.observers;return hasError||isStopped?EMPTY_SUBSCRIPTION:(this.currentObservers=null,observers.push(subscriber),new Subscription(function(){_this.currentObservers=null,arrRemove(observers,subscriber)}))},Subject.prototype._checkFinalizedStatuses=function(subscriber){var hasError=this.hasError,thrownError=this.thrownError,isStopped=this.isStopped;hasError?subscriber.error(thrownError):isStopped&&subscriber.complete()},Subject.prototype.asObservable=function(){var observable=new Observable;return observable.source=this,observable},Subject.create=function(destination,source){return new AnonymousSubject(destination,source)},Subject}(Observable),AnonymousSubject=function(_super){function AnonymousSubject(destination,source){var _this=_super.call(this)||this;return _this.destination=destination,_this.source=source,_this}return __extends(AnonymousSubject,_super),AnonymousSubject.prototype.next=function(value){var _a,_b;null===(_b=null===(_a=this.destination)||void 0===_a?void 0:_a.next)||void 0===_b||_b.call(_a,value)},AnonymousSubject.prototype.error=function(err){var _a,_b;null===(_b=null===(_a=this.destination)||void 0===_a?void 0:_a.error)||void 0===_b||_b.call(_a,err)},AnonymousSubject.prototype.complete=function(){var _a,_b;null===(_b=null===(_a=this.destination)||void 0===_a?void 0:_a.complete)||void 0===_b||_b.call(_a)},AnonymousSubject.prototype._subscribe=function(subscriber){var _a,_b;return null!==(_b=null===(_a=this.source)||void 0===_a?void 0:_a.subscribe(subscriber))&&void 0!==_b?_b:EMPTY_SUBSCRIPTION},AnonymousSubject}(Subject),HotObservable=function(_super){function HotObservable(messages,scheduler){var _this=_super.call(this)||this;return _this.messages=messages,_this.subscriptions=[],_this.scheduler=scheduler,_this}return __extends(HotObservable,_super),HotObservable.prototype._subscribe=function(subscriber){var subject=this,index=subject.logSubscribedFrame(),subscription=new Subscription;return subscription.add(new Subscription(function(){subject.logUnsubscribedFrame(index)})),subscription.add(_super.prototype._subscribe.call(this,subscriber)),subscription},HotObservable.prototype.setup=function(){for(var subject=this,messagesLength=subject.messages.length,_loop_1=function(i){var _a,notification,frame;_a=subject.messages[i],notification=_a.notification,frame=_a.frame,subject.scheduler.schedule(function(){observeNotification(notification,subject)},frame)},i=0;i<messagesLength;i++)_loop_1(i)},HotObservable}(Subject);applyMixins(HotObservable,[SubscriptionLoggable]);var Action=function(_super){function Action(scheduler,work){return _super.call(this)||this}return __extends(Action,_super),Action.prototype.schedule=function(state,delay){return this},Action}(Subscription),intervalProvider={setInterval:function(handler,timeout){for(var args=[],_i=2;_i<arguments.length;_i++)args[_i-2]=arguments[_i];var delegate=intervalProvider.delegate;return(null==delegate?void 0:delegate.setInterval)?delegate.setInterval.apply(delegate,__spreadArray([handler,timeout],__read(args))):setInterval.apply(void 0,__spreadArray([handler,timeout],__read(args)))},clearInterval:function(handle){var delegate=intervalProvider.delegate;return((null==delegate?void 0:delegate.clearInterval)||clearInterval)(handle)},delegate:void 0},AsyncAction=function(_super){function AsyncAction(scheduler,work){var _this=_super.call(this,scheduler,work)||this;return _this.scheduler=scheduler,_this.work=work,_this.pending=!1,_this}return __extends(AsyncAction,_super),AsyncAction.prototype.schedule=function(state,delay){var _a;if(void 0===delay&&(delay=0),this.closed)return this;this.state=state;var id=this.id,scheduler=this.scheduler;return null!=id&&(this.id=this.recycleAsyncId(scheduler,id,delay)),this.pending=!0,this.delay=delay,this.id=null!==(_a=this.id)&&void 0!==_a?_a:this.requestAsyncId(scheduler,this.id,delay),this},AsyncAction.prototype.requestAsyncId=function(scheduler,_id,delay){return void 0===delay&&(delay=0),intervalProvider.setInterval(scheduler.flush.bind(scheduler,this),delay)},AsyncAction.prototype.recycleAsyncId=function(_scheduler,id,delay){if(void 0===delay&&(delay=0),null!=delay&&this.delay===delay&&!1===this.pending)return id;null!=id&&intervalProvider.clearInterval(id)},AsyncAction.prototype.execute=function(state,delay){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var error=this._execute(state,delay);if(error)return error;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},AsyncAction.prototype._execute=function(state,_delay){var errorValue,errored=!1;try{this.work(state)}catch(e){errored=!0,errorValue=e||new Error("Scheduled action threw falsy error")}if(errored)return this.unsubscribe(),errorValue},AsyncAction.prototype.unsubscribe=function(){if(!this.closed){var id=this.id,scheduler=this.scheduler,actions=scheduler.actions;this.work=this.state=this.scheduler=null,this.pending=!1,arrRemove(actions,this),null!=id&&(this.id=this.recycleAsyncId(scheduler,id,null)),this.delay=null,_super.prototype.unsubscribe.call(this)}},AsyncAction}(Action),dateTimestampProvider={now:function(){return(dateTimestampProvider.delegate||Date).now()},delegate:void 0},Scheduler=function(){function Scheduler(schedulerActionCtor,now){void 0===now&&(now=Scheduler.now),this.schedulerActionCtor=schedulerActionCtor,this.now=now}return Scheduler.prototype.schedule=function(work,delay,state){return void 0===delay&&(delay=0),new this.schedulerActionCtor(this,work).schedule(state,delay)},Scheduler.now=dateTimestampProvider.now,Scheduler}(),VirtualTimeScheduler=function(_super){function VirtualTimeScheduler(schedulerActionCtor,maxFrames){void 0===schedulerActionCtor&&(schedulerActionCtor=VirtualAction),void 0===maxFrames&&(maxFrames=1/0);var _this=_super.call(this,schedulerActionCtor,function(){return _this.frame})||this;return _this.maxFrames=maxFrames,_this.frame=0,_this.index=-1,_this}return __extends(VirtualTimeScheduler,_super),VirtualTimeScheduler.prototype.flush=function(){for(var error,action,actions=this.actions,maxFrames=this.maxFrames;(action=actions[0])&&action.delay<=maxFrames&&(actions.shift(),this.frame=action.delay,!(error=action.execute(action.state,action.delay))););if(error){for(;action=actions.shift();)action.unsubscribe();throw error}},VirtualTimeScheduler.frameTimeFactor=10,VirtualTimeScheduler}(function(_super){function AsyncScheduler(SchedulerAction,now){void 0===now&&(now=Scheduler.now);var _this=_super.call(this,SchedulerAction,now)||this;return _this.actions=[],_this._active=!1,_this}return __extends(AsyncScheduler,_super),AsyncScheduler.prototype.flush=function(action){var actions=this.actions;if(this._active)actions.push(action);else{var error;this._active=!0;do{if(error=action.execute(action.state,action.delay))break}while(action=actions.shift());if(this._active=!1,error){for(;action=actions.shift();)action.unsubscribe();throw error}}},AsyncScheduler}(Scheduler)),VirtualAction=function(_super){function VirtualAction(scheduler,work,index){void 0===index&&(index=scheduler.index+=1);var _this=_super.call(this,scheduler,work)||this;return _this.scheduler=scheduler,_this.work=work,_this.index=index,_this.active=!0,_this.index=scheduler.index=index,_this}return __extends(VirtualAction,_super),VirtualAction.prototype.schedule=function(state,delay){if(void 0===delay&&(delay=0),Number.isFinite(delay)){if(!this.id)return _super.prototype.schedule.call(this,state,delay);this.active=!1;var action=new VirtualAction(this.scheduler,this.work);return this.add(action),action.schedule(state,delay)}return Subscription.EMPTY},VirtualAction.prototype.requestAsyncId=function(scheduler,id,delay){void 0===delay&&(delay=0),this.delay=scheduler.frame+delay;var actions=scheduler.actions;return actions.push(this),actions.sort(VirtualAction.sortActions),1},VirtualAction.prototype.recycleAsyncId=function(scheduler,id,delay){},VirtualAction.prototype._execute=function(state,delay){if(!0===this.active)return _super.prototype._execute.call(this,state,delay)},VirtualAction.sortActions=function(a,b){return a.delay===b.delay?a.index===b.index?0:a.index>b.index?1:-1:a.delay>b.delay?1:-1},VirtualAction}(AsyncAction),TestScheduler=function(_super){function TestScheduler(assertDeepEqual){var _this=_super.call(this,VirtualAction,750)||this;return _this.assertDeepEqual=assertDeepEqual,_this.hotObservables=[],_this.coldObservables=[],_this.flushTests=[],_this.runMode=!1,_this}return __extends(TestScheduler,_super),TestScheduler.prototype.createTime=function(marbles){var indexOf=this.runMode?marbles.trim().indexOf("|"):marbles.indexOf("|");if(-1===indexOf)throw new Error("marble diagram for time should have a completion marker \"|\"");return indexOf*TestScheduler.frameTimeFactor},TestScheduler.prototype.createColdObservable=function(marbles,values,error){if(-1!==marbles.indexOf("^"))throw new Error("cold observable cannot have subscription offset \"^\"");if(-1!==marbles.indexOf("!"))throw new Error("cold observable cannot have unsubscription marker \"!\"");var messages=TestScheduler.parseMarbles(marbles,values,error,void 0,this.runMode),cold=new ColdObservable(messages,this);return this.coldObservables.push(cold),cold},TestScheduler.prototype.createHotObservable=function(marbles,values,error){if(-1!==marbles.indexOf("!"))throw new Error("hot observable cannot have unsubscription marker \"!\"");var messages=TestScheduler.parseMarbles(marbles,values,error,void 0,this.runMode),subject=new HotObservable(messages,this);return this.hotObservables.push(subject),subject},TestScheduler.prototype.materializeInnerObservable=function(observable,outerFrame){var _this=this,messages=[];return observable.subscribe({next:function(value){messages.push({frame:_this.frame-outerFrame,notification:nextNotification(value)})},error:function(error){messages.push({frame:_this.frame-outerFrame,notification:errorNotification(error)})},complete:function(){messages.push({frame:_this.frame-outerFrame,notification:COMPLETE_NOTIFICATION})}}),messages},TestScheduler.prototype.expectObservable=function(observable,subscriptionMarbles){var _this=this;void 0===subscriptionMarbles&&(subscriptionMarbles=null);var subscription,actual=[],flushTest={actual:actual,ready:!1},subscriptionParsed=TestScheduler.parseMarblesAsSubscriptions(subscriptionMarbles,this.runMode),subscriptionFrame=subscriptionParsed.subscribedFrame===1/0?0:subscriptionParsed.subscribedFrame,unsubscriptionFrame=subscriptionParsed.unsubscribedFrame;this.schedule(function(){subscription=observable.subscribe({next:function(x){var value=x instanceof Observable?_this.materializeInnerObservable(x,_this.frame):x;actual.push({frame:_this.frame,notification:nextNotification(value)})},error:function(error){actual.push({frame:_this.frame,notification:errorNotification(error)})},complete:function(){actual.push({frame:_this.frame,notification:COMPLETE_NOTIFICATION})}})},subscriptionFrame),unsubscriptionFrame!==1/0&&this.schedule(function(){return subscription.unsubscribe()},unsubscriptionFrame),this.flushTests.push(flushTest);var runMode=this.runMode;return{toBe:function(marbles,values,errorValue){flushTest.ready=!0,flushTest.expected=TestScheduler.parseMarbles(marbles,values,errorValue,!0,runMode)},toEqual:function(other){flushTest.ready=!0,flushTest.expected=[],_this.schedule(function(){subscription=other.subscribe({next:function(x){var value=x instanceof Observable?_this.materializeInnerObservable(x,_this.frame):x;flushTest.expected.push({frame:_this.frame,notification:nextNotification(value)})},error:function(error){flushTest.expected.push({frame:_this.frame,notification:errorNotification(error)})},complete:function(){flushTest.expected.push({frame:_this.frame,notification:COMPLETE_NOTIFICATION})}})},subscriptionFrame)}}},TestScheduler.prototype.expectSubscriptions=function(actualSubscriptionLogs){var flushTest={actual:actualSubscriptionLogs,ready:!1};this.flushTests.push(flushTest);var runMode=this.runMode;return{toBe:function(marblesOrMarblesArray){var marblesArray="string"==typeof marblesOrMarblesArray?[marblesOrMarblesArray]:marblesOrMarblesArray;flushTest.ready=!0,flushTest.expected=marblesArray.map(function(marbles){return TestScheduler.parseMarblesAsSubscriptions(marbles,runMode)}).filter(function(marbles){return marbles.subscribedFrame!==1/0})}}},TestScheduler.prototype.flush=function(){for(var _this=this,hotObservables=this.hotObservables;hotObservables.length>0;)hotObservables.shift().setup();_super.prototype.flush.call(this),this.flushTests=this.flushTests.filter(function(test){return!test.ready||(_this.assertDeepEqual(test.actual,test.expected),!1)})},TestScheduler.parseMarblesAsSubscriptions=function(marbles,runMode){var _this=this;if(void 0===runMode&&(runMode=!1),"string"!=typeof marbles)return new SubscriptionLog(1/0);for(var out_i_1,characters=__spreadArray([],__read(marbles)),len=characters.length,groupStart=-1,subscriptionFrame=1/0,unsubscriptionFrame=1/0,frame=0,_loop_1=function(i){var nextFrame=frame,advanceFrameBy=function(count){nextFrame+=count*_this.frameTimeFactor},c=characters[i];switch(c){case" ":runMode||advanceFrameBy(1);break;case"-":advanceFrameBy(1);break;case"(":groupStart=frame,advanceFrameBy(1);break;case")":groupStart=-1,advanceFrameBy(1);break;case"^":if(subscriptionFrame!==1/0)throw new Error("found a second subscription point '^' in a subscription marble diagram. There can only be one.");subscriptionFrame=groupStart>-1?groupStart:frame,advanceFrameBy(1);break;case"!":if(unsubscriptionFrame!==1/0)throw new Error("found a second unsubscription point '!' in a subscription marble diagram. There can only be one.");unsubscriptionFrame=groupStart>-1?groupStart:frame;break;default:if(runMode&&c.match(/^[0-9]$/)&&(0===i||" "===characters[i-1])){var match=characters.slice(i).join("").match(/^([0-9]+(?:\.[0-9]+)?)(ms|s|m) /);if(match){i+=match[0].length-1;var duration=parseFloat(match[1]),durationInMs=void 0;switch(match[2]){case"ms":durationInMs=duration;break;case"s":durationInMs=1e3*duration;break;case"m":durationInMs=1e3*duration*60;}advanceFrameBy(durationInMs/this_1.frameTimeFactor);break}}throw new Error("there can only be '^' and '!' markers in a subscription marble diagram. Found instead '"+c+"'.");}frame=nextFrame,out_i_1=i},this_1=this,i=0;i<len;i++)_loop_1(i),i=out_i_1;return unsubscriptionFrame<0?new SubscriptionLog(subscriptionFrame):new SubscriptionLog(subscriptionFrame,unsubscriptionFrame)},TestScheduler.parseMarbles=function(marbles,values,errorValue,materializeInnerObservables,runMode){var _this=this;if(void 0===materializeInnerObservables&&(materializeInnerObservables=!1),void 0===runMode&&(runMode=!1),-1!==marbles.indexOf("!"))throw new Error("conventional marble diagrams cannot have the unsubscription marker \"!\"");for(var out_i_2,characters=__spreadArray([],__read(marbles)),len=characters.length,testMessages=[],subIndex=runMode?marbles.replace(/^[ ]+/,"").indexOf("^"):marbles.indexOf("^"),frame=-1===subIndex?0:subIndex*-this.frameTimeFactor,getValue="object"!=typeof values?function(x){return x}:function(x){return materializeInnerObservables&&values[x]instanceof ColdObservable?values[x].messages:values[x]},groupStart=-1,_loop_2=function(i){var nextFrame=frame,advanceFrameBy=function(count){nextFrame+=count*_this.frameTimeFactor},notification=void 0,c=characters[i];switch(c){case" ":runMode||advanceFrameBy(1);break;case"-":case"^":advanceFrameBy(1);break;case"(":groupStart=frame,advanceFrameBy(1);break;case")":groupStart=-1,advanceFrameBy(1);break;case"|":notification=COMPLETE_NOTIFICATION,advanceFrameBy(1);break;case"#":notification=errorNotification(errorValue||"error"),advanceFrameBy(1);break;default:if(runMode&&c.match(/^[0-9]$/)&&(0===i||" "===characters[i-1])){var match=characters.slice(i).join("").match(/^([0-9]+(?:\.[0-9]+)?)(ms|s|m) /);if(match){i+=match[0].length-1;var duration=parseFloat(match[1]),durationInMs=void 0;switch(match[2]){case"ms":durationInMs=duration;break;case"s":durationInMs=1e3*duration;break;case"m":durationInMs=1e3*duration*60;}advanceFrameBy(durationInMs/this_2.frameTimeFactor);break}}notification=nextNotification(getValue(c)),advanceFrameBy(1);}notification&&testMessages.push({frame:groupStart>-1?groupStart:frame,notification:notification}),frame=nextFrame,out_i_2=i},this_2=this,i=0;i<len;i++)_loop_2(i),i=out_i_2;return testMessages},TestScheduler.prototype.createAnimator=function(){var _this=this;if(!this.runMode)throw new Error("animate() must only be used in run mode");var map,lastHandle=0;return{animate:function(marbles){var e_1,_a;if(map)throw new Error("animate() must not be called more than once within run()");if(/[|#]/.test(marbles))throw new Error("animate() must not complete or error");map=new Map;var messages=TestScheduler.parseMarbles(marbles,void 0,void 0,void 0,!0);try{for(var messages_1=__values(messages),messages_1_1=messages_1.next();!messages_1_1.done;messages_1_1=messages_1.next()){var message=messages_1_1.value;_this.schedule(function(){var e_2,_a,now=_this.now(),callbacks=Array.from(map.values());map.clear();try{for(var callbacks_1=(e_2=void 0,__values(callbacks)),callbacks_1_1=callbacks_1.next();!callbacks_1_1.done;callbacks_1_1=callbacks_1.next()){(0,callbacks_1_1.value)(now)}}catch(e_2_1){e_2={error:e_2_1}}finally{try{callbacks_1_1&&!callbacks_1_1.done&&(_a=callbacks_1.return)&&_a.call(callbacks_1)}finally{if(e_2)throw e_2.error}}},message.frame)}}catch(e_1_1){e_1={error:e_1_1}}finally{try{messages_1_1&&!messages_1_1.done&&(_a=messages_1.return)&&_a.call(messages_1)}finally{if(e_1)throw e_1.error}}},delegate:{requestAnimationFrame:function(callback){if(!map)throw new Error("animate() was not called within run()");var handle=++lastHandle;return map.set(handle,callback),handle},cancelAnimationFrame:function(handle){if(!map)throw new Error("animate() was not called within run()");map.delete(handle)}}}},TestScheduler.prototype.createDelegates=function(){var _this=this,lastHandle=0,scheduleLookup=new Map,run=function(){var now=_this.now(),scheduledRecordsDue=Array.from(scheduleLookup.values()).filter(function(_a){return _a.due<=now}),dueImmediates=scheduledRecordsDue.filter(function(_a){return"immediate"===_a.type});if(dueImmediates.length>0){var _a=dueImmediates[0],handle=_a.handle,handler=_a.handler;return scheduleLookup.delete(handle),void handler()}var dueIntervals=scheduledRecordsDue.filter(function(_a){return"interval"===_a.type});if(dueIntervals.length>0){var firstDueInterval=dueIntervals[0],duration=firstDueInterval.duration;handler=firstDueInterval.handler;return firstDueInterval.due=now+duration,firstDueInterval.subscription=_this.schedule(run,duration),void handler()}var dueTimeouts=scheduledRecordsDue.filter(function(_a){return"timeout"===_a.type});if(dueTimeouts.length>0){var _b=dueTimeouts[0];handle=_b.handle,handler=_b.handler;return scheduleLookup.delete(handle),void handler()}throw new Error("Expected a due immediate or interval")};return{immediate:{setImmediate:function(handler){var handle=++lastHandle;return scheduleLookup.set(handle,{due:_this.now(),duration:0,handle:handle,handler:handler,subscription:_this.schedule(run,0),type:"immediate"}),handle},clearImmediate:function(handle){var value=scheduleLookup.get(handle);value&&(value.subscription.unsubscribe(),scheduleLookup.delete(handle))}},interval:{setInterval:function(handler,duration){void 0===duration&&(duration=0);var handle=++lastHandle;return scheduleLookup.set(handle,{due:_this.now()+duration,duration:duration,handle:handle,handler:handler,subscription:_this.schedule(run,duration),type:"interval"}),handle},clearInterval:function(handle){var value=scheduleLookup.get(handle);value&&(value.subscription.unsubscribe(),scheduleLookup.delete(handle))}},timeout:{setTimeout:function(handler,duration){void 0===duration&&(duration=0);var handle=++lastHandle;return scheduleLookup.set(handle,{due:_this.now()+duration,duration:duration,handle:handle,handler:handler,subscription:_this.schedule(run,duration),type:"timeout"}),handle},clearTimeout:function(handle){var value=scheduleLookup.get(handle);value&&(value.subscription.unsubscribe(),scheduleLookup.delete(handle))}}}},TestScheduler.prototype.run=function(callback){var prevFrameTimeFactor=TestScheduler.frameTimeFactor,prevMaxFrames=this.maxFrames;TestScheduler.frameTimeFactor=1,this.maxFrames=1/0,this.runMode=!0;var animator=this.createAnimator(),delegates=this.createDelegates();animator.delegate,dateTimestampProvider.delegate=this,delegates.immediate,intervalProvider.delegate=delegates.interval,timeoutProvider.delegate=delegates.timeout;var helpers={cold:this.createColdObservable.bind(this),hot:this.createHotObservable.bind(this),flush:this.flush.bind(this),time:this.createTime.bind(this),expectObservable:this.expectObservable.bind(this),expectSubscriptions:this.expectSubscriptions.bind(this),animate:animator.animate};try{var ret=callback(helpers);return this.flush(),ret}finally{TestScheduler.frameTimeFactor=prevFrameTimeFactor,this.maxFrames=prevMaxFrames,this.runMode=!1,dateTimestampProvider.delegate=void 0,intervalProvider.delegate=void 0,timeoutProvider.delegate=void 0}},TestScheduler.frameTimeFactor=10,TestScheduler}(VirtualTimeScheduler);export{TestScheduler};